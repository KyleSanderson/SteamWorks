name: SteamWorks.ext Build

on:
  push:
    branches: [ master, windows98 ]
  pull_request:
    branches: [ master, windows98 ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python-version: [2.7, 3.3, 3.8]
        os: [ubuntu-18.04, macos-latest, windows-2019]
        exclude:
         - os: macos-latest
           python-version: 3.3
         - os: windows-2019
           python-version: 3.3

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install Deps
      if: runner.os == 'Linux'
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get install lib32stdc++-7-dev lib32z1-dev libc6-dev-i386
        sudo apt-get install g++-multilib
    - uses: actions/checkout@v2
      with:
        repository: 'https://github.com/alliedmodders/ambuild.git'
        path: 'assets'
    - name: install AMBuild
      run: pip install ./assets/ambuild
    - uses: actions/checkout@v2
      with:
        repository: 'https://github.com/SteamDatabase/SteamworksSDK.git'
        path: 'assets/SteamWorksSDK'
    - uses: actions/checkout@v2
      with:
        repository: 'https://github.com/alliedmodders/hl2sdk.git'
        ref: 'sdk2013'
        path: 'assets/sdk2013'
    - uses: actions/checkout@v2
      with:
        repository: 'https://github.com/alliedmodders/metamod-source.git'
        ref: '1.10-dev'
        path: 'assets/mmsource-central'
    - uses: actions/checkout@v2
      with:
        repository: 'https://github.com/alliedmodders/sourcemod.git'
        ref: '1.7-dev'
        path: 'assets/sourcemod-central'
    - name: Create Build folder
      run: |
        mkdir build
        cd build
    - name: Create redundant AMBuildScript
      run: cp ../AMBuildScript ../../
    - name: Configure
      run: python ../configure.py -s sdk2013 --hl2sdk-root ../assets --sm-path ../assets/sourcemod-central --mms-path ../assets/mmsource-central --steamworks-path ../assets/SteamworksSD
    - name: Build
      run: ambuild
