name: SteamWorks.ext Build

on:
  push:
    branches: [ master, windows98 ]
  pull_request:
    branches: [ master, windows98 ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python-version: [3.8]
        os: [ubuntu-18.04, macos-latest, windows-2019]

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install Deps
      if: runner.os == 'Linux'
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get install lib32stdc++-7-dev lib32z1-dev libc6-dev-i386
        sudo apt-get install g++-multilib
    - uses: actions/checkout@v2
      name: Clone AMBuild
      with:
        repository: 'alliedmodders/ambuild'
        path: 'assets/ambuild'
    - name: install AMBuild
      run: pip install ./assets/ambuild
    - uses: actions/checkout@v2
      name: Clone SteamworksSDK
      with:
        repository: 'SteamDatabase/SteamworksSDK'
        path: 'assets/SteamworksSDK'
        token: ${{ secrets.OAUTH }}
    - uses: actions/checkout@v2
      name: Clone hl2sdk-sdk2013
      with:
        repository: 'alliedmodders/hl2sdk'
        ref: 'sdk2013'
        path: 'assets/hl2sdk-sdk2013'
    - uses: actions/checkout@v2
      name: Clone Metamod Source
      with:
        repository: 'alliedmodders/metamod-source'
        ref: '1.10-dev'
        path: 'assets/mmsource-central'
    - uses: actions/checkout@v2
      name: Clone Sourcemod
      with:
        repository: 'alliedmodders/sourcemod'
        ref: '1.7-dev'
        path: 'assets/sourcemod-central'
    - name: Create Build folder
      run: mkdir build
    - name: Create redundant AMBuildScript
      run: cp AMBuildScript ../
    - name: Configure
      run: |
        cd build
        python ../configure.py -s sdk2013 --hl2sdk-root ../assets --sm-path ../assets/sourcemod-central --mms-path ../assets/mmsource-central --steamworks-path ../assets/SteamworksSDK
    - name: Build
      run: |
        cd build
        ambuild
